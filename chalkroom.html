<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Punk Vision Board</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: 'Press Start 2P', monospace;
}

.hidden { display:none; }

/* AUTH */
#auth {
  height: 100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

.auth-box {
  border: 3px solid #ff00ff;
  padding: 30px;
  background:#000;
  box-shadow: 0 0 20px #00ffff;
  text-align:center;
}

.auth-box input {
  width: 90%;
  margin: 8px 0;
  padding: 10px;
  background:#111;
  color:#0ff;
  border:2px solid #ff0;
  font-family:inherit;
}

.auth-box button {
  margin-top:10px;
  padding:10px 20px;
  background:#ff0;
  border:none;
  cursor:pointer;
}

/* BOARD */
#board {
  padding:20px;
}

header {
  display:flex;
  align-items:center;
  gap:15px;
  margin-bottom:20px;
}

header img {
  width:60px;
  height:60px;
  border-radius:50%;
  border:3px solid #ff0;
  object-fit:cover;
}

#notes {
  display:flex;
  flex-wrap:wrap;
  gap:15px;
}

.note {
  width:140px;
  min-height:110px;
  padding:10px;
  background:#ffeb3b;
  color:#000;
  transform: rotate(var(--r));
  box-shadow:5px 5px 0 #000;
  font-size:0.6em;
}

textarea {
  width:100%;
  margin-top:15px;
  padding:10px;
  background:#111;
  color:#fff;
  border:2px dashed #0ff;
  font-family:inherit;
}

</style>
</head>
<body>

<!-- AUTH -->
<div id="auth">
  <div class="auth-box">
    <h2>PUNK ZEN</h2>
    <input id="username" placeholder="username (signup only)">
    <input id="email" placeholder="email">
    <input id="password" type="password" placeholder="password">
    <button onclick="signup()">SIGN UP</button>
    <button onclick="login()">LOG IN</button>
  </div>
</div>

<!-- BOARD -->
<div id="board" class="hidden">
  <header>
    <img id="avatar">
    <div>
      <div id="welcome"></div>
      <input type="file" onchange="uploadAvatar(event)">
    </div>
  </header>

  <div id="notes"></div>

  <textarea id="noteInput" placeholder="Leave your mark..."></textarea>
  <button onclick="postNote()">POST NOTE</button>
</div>

<script>
/* ==========================
   SUPABASE INIT (FIXED)
========================== */
const supabase = window.supabase.createClient(
  'https://hwymepujsvfqjkbullaf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3eW1lcHVqc3ZmcWprYnVsbGFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDczOTQsImV4cCI6MjA4NDI4MzM5NH0.V6-Cm331IocSXDqe-v6iAZA3TV1STyEHyQI43lcXU_4'
);

let user = null;

/* ==========================
   AUTH FUNCTIONS
========================== */
async function signup() {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  const username = document.getElementById('username').value.trim();

  if (!email || !password || !username) {
    alert('All fields required for signup');
    return;
  }

  const { error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: { username }
    }
  });

  if (error) {
    alert(error.message);
  } else {
    alert('Signup successful â€” check your email!');
  }
}

async function login() {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();

  if (!email || !password) {
    alert('Missing email or password');
    return;
  }

  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  });

  if (error) {
    alert(error.message);
  } else {
    initUser(data.user);
  }
}

/* ==========================
   SESSION PERSISTENCE
========================== */
supabase.auth.onAuthStateChange((event, session) => {
  if (session?.user) {
    initUser(session.user);
  }
});

/* ==========================
   POST-LOGIN INIT
========================== */
function initUser(u) {
  user = u;

  document.getElementById('auth').classList.add('hidden');
  document.getElementById('board').classList.remove('hidden');

  const username =
    user.user_metadata.username ||
    user.email.split('@')[0];

  document.getElementById('welcome').innerText =
    `welcome ${username}`;

  loadProfile();
  loadNotes();
}

/* ==========================
   PROFILE
========================== */
async function loadProfile() {
  const { data } = await supabase
    .from('profiles')
    .select('avatar_url')
    .eq('id', user.id)
    .single();

  document.getElementById('avatar').src =
    data?.avatar_url || 'https://placehold.co/100x100';
}

async function uploadAvatar(e) {
  const file = e.target.files[0];
  if (!file) return;

  const path = `${user.id}.png`;

  await supabase.storage
    .from('avatars')
    .upload(path, file, { upsert: true });

  const url = supabase.storage
    .from('avatars')
    .getPublicUrl(path).data.publicUrl;

  await supabase.from('profiles').upsert({
    id: user.id,
    avatar_url: url
  });

  loadProfile();
}

/* ==========================
   NOTES
========================== */
async function loadNotes() {
  const { data } = await supabase
    .from('chalkboard_notes')
    .select('*')
    .order('created_at', { ascending: false });

  const board = document.getElementById('notes');
  board.innerHTML = '';

  data.forEach(n => {
    const note = document.createElement('div');
    note.className = 'note';
    note.style.setProperty('--r', `${n.rotation}deg`);
    note.innerHTML =
      `<strong>${n.username}</strong><br>${n.message}`;
    board.appendChild(note);
  });
}

async function postNote() {
  const msg = document.getElementById('noteInput').value.trim();
  if (!msg) return;

  await supabase.from('chalkboard_notes').insert({
    user_id: user.id,
    username: user.user_metadata.username,
    message: msg,
    rotation: Math.random() * 10 - 5
  });

  document.getElementById('noteInput').value = '';
  loadNotes();
}
</script>
</body>
</html>
