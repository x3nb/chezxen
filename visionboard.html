<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Punk Vision Board</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Vast+Shadow&display=swap" rel="stylesheet" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin:0;
  background:#000;
  color:#fff;
  font-family:'Press Start 2P', cursive;
}

.hidden { display:none; }

/* AUTH */
#auth {
  text-align:center;
  padding:40px;
}

.auth-box {
  border:3px solid #ff00ff;
  padding:30px;
  max-width:420px;
  margin:0 auto;
  background:#000;
}

/* BOARD */
#board {
  padding:20px;
}

header {
  display:flex;
  align-items:center;
  gap:15px;
  margin-bottom:20px;
}

header img {
  width:60px;
  height:60px;
  border-radius:50%;
  border:3px solid #ff0;
  object-fit:cover;
}

#notes {
  display:flex;
  flex-wrap:wrap;
  gap:15px;
}

.note {
  width:140px;
  min-height:110px;
  padding:10px;
  background:#ffeb3b;
  color:#000;
  transform: rotate(var(--r));
  box-shadow:5px 5px 0 #000;
  font-size:0.6em;
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth">
  <div class="auth-box">
    <h2 style="font-family:'Vast Shadow'">PUNK ZEN</h2>
    <input id="username" placeholder="username (signup only)"><br><br>
    <input id="email" placeholder="email"><br><br>
    <input id="password" type="password" placeholder="password"><br><br>
    <button onclick="signup()">SIGN UP</button>
    <button onclick="login()">LOG IN</button>
  </div>
</div>

<!-- BOARD -->
<div id="board" class="hidden">
  <header>
    <img id="avatar">
    <div>
      <div id="welcome"></div>
      <input type="file" onchange="uploadAvatar(event)">
    </div>
  </header>

  <div id="notes"></div>

  <textarea id="noteInput" placeholder="Leave your mark..."></textarea>
  <button onclick="postNote()">POST NOTE</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* SUPABASE INIT â€” SAME PATTERN AS YOUR WORKING FILE */
  const supabaseUrl = 'https://hwymepujsvfqjkbullaf.supabase.co';
  const supabaseKey = 'YOUR_PUBLIC_ANON_KEY';
  window.supabase = supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = null;

  /* AUTH */
  window.signup = async () => {
    const email = emailInput().value;
    const password = passwordInput().value;
    const username = usernameInput().value;

    const { error } = await supabase.auth.signUp({
      email,
      password,
      options: { data: { username } }
    });

    if (error) alert(error.message);
    else alert('Check your email (if enabled)');
  };

  window.login = async () => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email: emailInput().value,
      password: passwordInput().value
    });

    if (error) {
      alert(error.message);
      return;
    }

    initUser(data.user);
  };

  /* SESSION RESTORE */
  supabase.auth.onAuthStateChange((_, session) => {
    if (session?.user) initUser(session.user);
  });

  function initUser(user) {
    currentUser = user;

    document.getElementById('auth').classList.add('hidden');
    document.getElementById('board').classList.remove('hidden');

    const name =
      user.user_metadata.username ||
      user.email.split('@')[0];

    document.getElementById('welcome').innerText =
      `welcome ${name}`;

    loadProfile();
    loadNotes();
  }

  /* PROFILE */
  async function loadProfile() {
    const { data } = await supabase
      .from('profiles')
      .select('avatar_url')
      .eq('id', currentUser.id)
      .single();

    document.getElementById('avatar').src =
      data?.avatar_url || 'https://placehold.co/100x100';
  }

  window.uploadAvatar = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const path = `${currentUser.id}.png`;

    await supabase.storage
      .from('avatars')
      .upload(path, file, { upsert:true });

    const url = supabase.storage
      .from('avatars')
      .getPublicUrl(path).data.publicUrl;

    await supabase.from('profiles').upsert({
      id: currentUser.id,
      avatar_url: url
    });

    loadProfile();
  };

  /* NOTES */
  async function loadNotes() {
    const { data } = await supabase
      .from('chalkboard_notes')
      .select('*')
      .order('created_at', { ascending:false });

    const board = document.getElementById('notes');
    board.innerHTML = '';

    data.forEach(n => {
      const div = document.createElement('div');
      div.className = 'note';
      div.style.setProperty('--r', `${n.rotation}deg`);
      div.innerHTML =
        `<strong>${n.username}</strong><br>${n.message}`;
      board.appendChild(div);
    });
  }

  window.postNote = async () => {
    const msg = noteInput().value.trim();
    if (!msg) return;

    await supabase.from('chalkboard_notes').insert({
      user_id: currentUser.id,
      username: currentUser.user_metadata.username,
      message: msg,
      rotation: Math.random()*10 - 5
    });

    noteInput().value='';
    loadNotes();
  };

  /* HELPERS */
  const emailInput = () => document.getElementById('email');
  const passwordInput = () => document.getElementById('password');
  const usernameInput = () => document.getElementById('username');
  const noteInput = () => document.getElementById('noteInput');
});
</script>
</body>
</html>
