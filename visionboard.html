<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Punk Vision Board</title>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
body {
  margin: 0;
  background: #000;
  color: #f5f5f5;
  font-family: 'Press Start 2P';
}

.hidden { display: none; }

#auth, #board {
  padding: 30px;
}

input, textarea, button {
  background: #111;
  color: #0ff;
  border: 2px solid #ff00ff;
  padding: 10px;
  margin: 5px 0;
  font-family: inherit;
}

button {
  cursor: pointer;
  background: #ff00ff;
  color: black;
}

header {
  display: flex;
  align-items: center;
  gap: 20px;
  border-bottom: 2px dashed #0ff;
  padding-bottom: 20px;
}

#avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 2px solid #0ff;
  object-fit: cover;
}

#notes {
  margin-top: 30px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 15px;
}

.note {
  background: #0b0b0b;
  border: 2px dashed #ff00ff;
  padding: 15px;
  position: relative;
}

.note button {
  position: absolute;
  top: 5px;
  right: 5px;
  background: red;
  color: white;
  font-size: 10px;
}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth">
  <h2>ENTER THE BOARD</h2>
  <input id="email" placeholder="email" />
  <input id="password" type="password" placeholder="password" />
  <input id="username" placeholder="punk alias" />
  <br>
  <button onclick="signup()">REGISTER</button>
  <button onclick="login()">LOGIN</button>
</div>

<!-- BOARD -->
<div id="board" class="hidden">
  <header>
    <img id="avatar">
    <div>
      <div id="welcome"></div>
      <input type="file" onchange="uploadAvatar(event)">
      <br>
      <button onclick="logout()">LOG OUT</button>
    </div>
  </header>

  <h3>CHALK NOTES</h3>
  <textarea id="noteText" placeholder="write something raw..."></textarea>
  <br>
  <button onclick="postNote()">POST</button>

  <div id="notes"></div>
</div>

<script>
const supabase = window.supabase.createClient(
  'https://hwymepujsvfqjkbullaf.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3eW1lcHVqc3ZmcWprYnVsbGFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MDczOTQsImV4cCI6MjA4NDI4MzM5NH0.V6-Cm331IocSXDqe-v6iAZA3TV1STyEHyQI43lcXU_4'
);

let currentUser = null;

/* ---------------- AUTH ---------------- */

async function signup() {
  const email = emailEl.value;
  const password = passwordEl.value;
  const username = usernameEl.value;

  const { error } = await supabase.auth.signUp({
    email, password,
    options: { data: { username } }
  });

  if (error) alert(error.message);
  else alert('Check email or login.');
}

async function login() {
  const { data, error } =
    await supabase.auth.signInWithPassword({
      email: emailEl.value,
      password: passwordEl.value
    });

  if (error) alert(error.message);
  else initUser(data.user);
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

supabase.auth.onAuthStateChange((_, session) => {
  if (session?.user) initUser(session.user);
});

/* ---------------- USER INIT ---------------- */

function initUser(user) {
  currentUser = user;

  auth.classList.add('hidden');
  board.classList.remove('hidden');

  welcome.textContent = `HELLO ${user.user_metadata.username || 'PUNK'}`;

  loadAvatar();
  loadNotes();
  subscribeNotes();
}

/* ---------------- AVATAR ---------------- */

async function uploadAvatar(e) {
  const file = e.target.files[0];
  const path = `${currentUser.id}/avatar.png`;

  await supabase.storage.from('avatars').upload(path, file, { upsert: true });

  loadAvatar();
}

async function loadAvatar() {
  const { data } =
    supabase.storage.from('avatars')
      .getPublicUrl(`${currentUser.id}/avatar.png`);

  avatar.src = data.publicUrl || '';
}

/* ---------------- NOTES ---------------- */

async function postNote() {
  const text = noteText.value.trim();
  if (!text) return;

  await supabase.from('notes').insert({
    content: text,
    user_id: currentUser.id,
    username: currentUser.user_metadata.username
  });

  noteText.value = '';
}

async function loadNotes() {
  const { data } =
    await supabase.from('notes')
      .select('*')
      .order('created_at', { ascending: false });

  renderNotes(data);
}

function renderNotes(notes) {
  notesEl.innerHTML = '';
  notes.forEach(n => {
    const div = document.createElement('div');
    div.className = 'note';
    div.innerHTML = `
      <strong>${n.username || 'anon'}</strong>
      <p>${n.content}</p>
      ${n.user_id === currentUser.id
        ? `<button onclick="deleteNote('${n.id}')">X</button>`
        : ''}
    `;
    notesEl.appendChild(div);
  });
}

async function deleteNote(id) {
  await supabase.from('notes').delete().eq('id', id);
}

/* ---------------- REALTIME ---------------- */

function subscribeNotes() {
  supabase
    .channel('notes')
    .on('postgres_changes',
      { event: '*', schema: 'public', table: 'notes' },
      loadNotes
    )
    .subscribe();
}

/* ---------------- ELEMENTS ---------------- */

const emailEl = document.getElementById('email');
const passwordEl = document.getElementById('password');
const usernameEl = document.getElementById('username');
const auth = document.getElementById('auth');
const board = document.getElementById('board');
const welcome = document.getElementById('welcome');
const avatar = document.getElementById('avatar');
const noteText = document.getElementById('noteText');
const notesEl = document.getElementById('notes');
</script>

</body>
</html>
